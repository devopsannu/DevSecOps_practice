name: forntend_SAST_monolithic

trigger:
  - main

pool: recap-pool

stages:
  - stage: Install_Dependencies
    jobs:
      - job: Install_node_tool
        steps:
        - task: NodeTool@0
          displayName: Install_node_tool
          inputs:
            versionSource: 'spec'
            versionSpec: '18.x'

        - task: Npm@1
          displayName: Install_npm_tool
          condition: false
          
          inputs:
            command: 'install'
            workingDir: '$(System.DefaultWorkingDirectory)/ReactTodoUIMonolith'
        - task: PowerShell@2
          displayName: Lint JavaScript (Biome)+ # Run Biome checks+Init Biome config
          continueOnError: true
          condition: false
          inputs:
            targetType: 'inline'
            script:  |
              npm install --save-dev @biomejs/biome
              npx biome init 
              npx biome check .
            workingDir: '$(System.DefaultWorkingDirectory)/ReactTodoUIMonolith'

        - task: Npm@1
          displayName: NPM Audit
          continueOnError: true
          condition: false
          inputs:
            command: 'custom'
            workingDir: '$(System.DefaultWorkingDirectory)/ReactTodoUIMonolith'
            customCommand: 'audit'

        - task: trivy@2
          displayName: Trivy_scan
          continueOnError: true
          condition: false
          inputs:
            method: 'system'
            type: 'filesystem'
            target: '$(System.DefaultWorkingDirectory)/ReactTodoUIMonolith'
            scanners: 'license, misconfig, secret, vuln'
            severities: 'LOW, MEDIUM, HIGH, CRITICAL'
            failOnSeverityThreshold: 'HIGH'
            reports: 'html'
            publish: true

  - stage: Sonarqube_scan
    dependsOn: Install_Dependencies
    displayName: sonarqube_scaner_quality
    jobs:
      - job: sonarqube_job
        displayName: Sonarqube_job
        steps:
         - powershell: |
              $url = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip"
              $zip = "$(Agent.TempDirectory)\sonar-scanner.zip"
              $dest = "$(Agent.ToolsDirectory)\sonar-scanner"

              Invoke-WebRequest $url -OutFile $zip
              Expand-Archive $zip -DestinationPath $dest -Force

              $scannerPath = Get-ChildItem $dest | Select-Object -First 1
              Write-Host "##vso[task.prependpath]$($scannerPath.FullName)\bin"
           displayName: Install Sonar Scanner CLI


         - script: |
            sonar-scanner ^
              -Dsonar.projectKey=Sonarqube_SAST_testing ^
              -Dsonar.projectName="Sonarqube_SAST_testing" ^
              -Dsonar.sources=src ^
              -Dsonar.exclusions=**/node_modules/**,**/build/** ^
              -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info ^
              -Dsonar.sourceEncoding=UTF-8 ^
              -Dsonar.host.url=http://localhost:9000/ ^
              -Dsonar.login=squ_e7e4e367c66a121abea9ff38ca156d65b20e118f
           workingDirectory: $(System.DefaultWorkingDirectory)/ReactTodoUIMonolith




